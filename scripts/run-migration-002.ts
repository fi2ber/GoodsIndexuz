import { config } from "dotenv";
import { resolve } from "path";

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env.local
config({ path: resolve(process.cwd(), ".env.local") });

import { sql, closeConnection } from "../lib/db/connection";
import { readFileSync } from "fs";
import { join } from "path";

async function runMigration002() {
  try {
    console.log("üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 002_add_product_fields.sql...\n");
    const migrationSQL = readFileSync(
      join(process.cwd(), "supabase/migrations/002_add_product_fields.sql"),
      "utf-8"
    );
    
    // –†–∞–∑–¥–µ–ª—è–µ–º SQL –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    const statements = migrationSQL
      .split(";")
      .map((s) => s.trim())
      .filter((s) => s.length > 0 && !s.startsWith("--"));

    for (const statement of statements) {
      if (statement.trim()) {
        try {
          await sql.unsafe(statement);
        } catch (error: any) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ "already exists" –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
          if (
            !error.message?.includes("already exists") &&
            !error.message?.includes("duplicate column") &&
            !error.message?.includes("relation") &&
            !error.message?.includes("already exists")
          ) {
            throw error;
          } else {
            console.log(`‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç): ${statement.substring(0, 50)}...`);
          }
        }
      }
    }
    
    console.log("\n‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è 002_add_product_fields.sql –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
    await closeConnection();
    process.exit(0);
  } catch (error: any) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:", error.message);
    await closeConnection();
    process.exit(1);
  }
}

runMigration002();

